{% extends "base.html" %}

{% block title %}Detalle del Itinerario: {{ trip.tripName }} | TravelDream{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/trip-builder.css') }}">
<style>
    .trip-detail-hero {
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        padding: 4rem 2rem;
        border-radius: 30px;
        color: white;
        margin-bottom: -3rem;
        position: relative;
        z-index: 1;
        overflow: hidden;
    }
    
    .detail-container {
        position: relative;
        z-index: 2;
    }

    .service-item-row {
        background: white;
        border-radius: 20px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border: 1px solid #f1f5f9;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s ease;
    }

    .service-item-row:hover {
        transform: scale(1.005);
        border-color: var(--wizard-primary);
    }

    .price-summary-card {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border-radius: 20px;
        padding: 2.5rem;
        box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
    }

    .icon-wrapper {
        width: 50px;
        height: 50px;
        background: #f1f5f9;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--wizard-primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5 wizard-container">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4 animate-fade-in">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('tripBuilder.my_trips') }}" class="text-decoration-none">Mis Itinerarios</a></li>
            <li class="breadcrumb-item active">{{ trip.tripName }}</li>
        </ol>
    </nav>

    <div class="trip-detail-hero animate-fade-in">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <span class="badge bg-primary px-3 py-2 rounded-pill mb-3">
                    <i class="fas fa-check-circle me-2"></i>{{ trip.status|capitalize }}
                </span>
                <h1 class="display-4 fw-bold mb-2">{{ trip.tripName }}</h1>
                <p class="lead opacity-75 mb-0">
                    <i class="far fa-calendar-alt me-2"></i>
                    {% if trip.startDate and trip.endDate %}
                        {{ trip.startDate.strftime('%d/%m/%Y') }} — {{ trip.endDate.strftime('%d/%m/%Y') }}
                    {% else %}
                        Fechas por definir
                    {% endif %}
                </p>
                <small class="opacity-50 mt-2 d-block">ID de Referencia: #{{ trip.idUserTrip }} | Creado: {{ trip.createdAt.strftime('%d de %B, %Y') }}</small>
            </div>
            <div class="col-lg-4 text-lg-end mt-4 mt-lg-0">
                {% if trip.status != 'cancelled' %}
                <form action="{{ url_for('tripBuilder.cancel_trip', idUserTrip=trip.idUserTrip) }}" 
                      method="post" 
                      onsubmit="return confirm('¿Estás seguro de que deseas cancelar este itinerario completo?');">
                    <button type="submit" class="btn btn-outline-light rounded-pill px-4">
                        <i class="fas fa-times-circle me-2"></i>Cancelar Itinerario
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="detail-container px-3 px-md-5">
        <div class="bg-white rounded-4 shadow-lg p-4 p-md-5 mb-5 animate-fade-in" style="animation-delay: 0.1s;">
            <h4 class="fw-bold mb-4 pb-3 border-bottom">Desglose de Servicios</h4>
            
            {% if trip.items %}
                {% for item in trip.items %}
                <div class="service-item-row">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <div class="icon-wrapper">
                                {% if item.itemType == 'accommodation' %}<i class="fas fa-hotel fa-lg"></i>
                                {% elif item.itemType == 'flight' %}<i class="fas fa-plane fa-lg"></i>
                                {% elif item.itemType == 'cruise' %}<i class="fas fa-ship fa-lg"></i>
                                {% elif item.itemType == 'car_rental' %}<i class="fas fa-car fa-lg"></i>
                                {% elif item.itemType == 'tour' %}<i class="fas fa-ticket-alt fa-lg"></i>
                                {% elif item.itemType == 'transport' %}<i class="fas fa-bus fa-lg"></i>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col">
                            {% set details = item.itemDetails|from_json if item.itemDetails else {} %}
                            <h6 class="fw-bold mb-1">
                                {% if item.itemType == 'accommodation' %}{{ details.get('name', 'Hotel') }}
                                {% elif item.itemType == 'flight' %}{{ details.get('origin', 'Origen') }} → {{ details.get('destination', 'Destino') }}
                                {% elif item.itemType == 'cruise' %}{{ details.get('name', 'Crucero') }}
                                {% elif item.itemType == 'car_rental' %}{{ details.get('brand', '') }} {{ details.get('model', '') }}
                                {% elif item.itemType == 'tour' %}{{ details.get('name', 'Tour') }}
                                {% elif item.itemType == 'transport' %}{{ details.get('origin', 'Origen') }} → {{ details.get('destination', 'Destino') }}
                                {% endif %}
                            </h6>
                            <small class="text-muted">
                                {% if item.itemType == 'accommodation' %}{{ details.get('address') }}
                                {% elif item.itemType == 'flight' %}{{ details.get('aeroline') }}
                                {% elif item.itemType == 'cruise' %}{{ details.get('description')|truncate(60) }}
                                {% elif item.itemType == 'car_rental' %}Alquiler de vehículo
                                {% elif item.itemType == 'transport' %}{{ details.get('type', '')|capitalize }}
                                {% endif %}
                            </small>
                        </div>
                        <div class="col-auto text-end">
                            <span class="fw-bold text-success fs-5">{{ item.itemPrice }}€</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-center text-muted py-4">No hay servicios registrados en este itinerario.</p>
            {% endif %}

            <div class="row mt-5 g-4 align-items-center">
                <div class="col-md-7">
                    <div class="alert alert-light border-0 rounded-4 p-4">
                        <h6 class="fw-bold mb-2"><i class="fas fa-info-circle me-2 text-primary"></i>Información Importante</h6>
                        <p class="small mb-0 text-muted">Este itinerario integra múltiples servicios independientes. Puedes ver los detalles de cada reserva en tu sección de "Mis Reservas" para gestionar cancelaciones individuales si están permitidas.</p>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="price-summary-card text-center">
                        <small class="opacity-75 d-block mb-1">Total del Itinerario</small>
                        <h2 class="display-5 fw-bold mb-0">{{ trip.totalPrice }}€</h2>
                        <small class="opacity-75">IVA incluido</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center animate-fade-in" style="animation-delay: 0.2s;">
            <a href="{{ url_for('tripBuilder.my_trips') }}" class="btn btn-link text-muted fw-bold text-decoration-none">
                <i class="fas fa-arrow-left me-2"></i>Volver a mis viajes
            </a>
            <button onclick="window.print()" class="btn btn-outline-primary rounded-pill px-4">
                <i class="fas fa-print me-2"></i>Imprimir Itinerario
            </button>
        </div>
    </div>
</div>
{% endblock %}
