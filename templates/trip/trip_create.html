{% extends "base.html" %}

{% block title %}Crear Viaje - Travel Booking{% endblock %}

{% block content %}
<div class="container py-5" style="max-width: 800px;">
  <div class="card shadow-sm border-0">
    <div class="card-header bg-primary text-white">
      <h2 class="h4 mb-0"><i class="fas fa-route me-2"></i>Crear Nuevo Viaje</h2>
    </div>
    <div class="card-body p-4">
      <p class="text-muted mb-4">Complete los detalles para crear un nuevo viaje.</p>

      <form method="POST" action="{{ url_for('trip.create_trip') }}" id="tripForm">
        
        <!-- Locations -->
        <h5 class="mb-3 text-secondary border-bottom pb-2">Ruta</h5>
        <div class="row g-3 mb-4">
          <div class="col-md-6">
            <label for="startLocation" class="form-label fw-bold">Origen <span class="text-danger">*</span></label>
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                <select name="startLocation" id="startLocation" class="form-select" required>
                <option value="">Seleccione origen...</option>
                {% for location in locations %}
                <option value="{{ location.idLocation }}">
                    {{ location.name }}, {{ location.country }}
                </option>
                {% endfor %}
                </select>
            </div>
          </div>

          <div class="col-md-6">
            <label for="endLocation" class="form-label fw-bold">Destino <span class="text-danger">*</span></label>
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-map-pin"></i></span>
                <select name="endLocation" id="endLocation" class="form-select" required>
                <option value="">Seleccione destino...</option>
                {% for location in locations %}
                <option value="{{ location.idLocation }}">
                    {{ location.name }}, {{ location.country }}
                </option>
                {% endfor %}
                </select>
            </div>
          </div>
        </div>

        <!-- Dates -->
        <h5 class="mb-3 text-secondary border-bottom pb-2">Fechas</h5>
        <div class="row g-3 mb-4">
          <div class="col-md-6">
            <label for="startDate" class="form-label fw-bold">Fecha de Salida <span class="text-danger">*</span></label>
            <input type="datetime-local" name="startDate" id="startDate" class="form-control" required />
            <div class="form-text">Formato: dd/mm/aaaa hh:mm</div>
          </div>

          <div class="col-md-6">
            <label for="endDate" class="form-label fw-bold">Fecha de Llegada <span class="text-danger">*</span></label>
            <input type="datetime-local" name="endDate" id="endDate" class="form-control" required />
            <div class="form-text">Formato: dd/mm/aaaa hh:mm</div>
          </div>
        </div>

        <!-- capacity and price -->
        <h5 class="mb-3 text-secondary border-bottom pb-2">Detalles del Viaje</h5>
        <div class="row g-3 mb-4">
          <div class="col-md-6">
            <label for="occupants" class="form-label fw-bold">Número de Personas <span class="text-danger">*</span></label>
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-users"></i></span>
                <input type="number" name="occupants" id="occupants" class="form-control" min="1" required placeholder="Ej: 2"/>
            </div>
          </div>

          <div class="col-md-6">
            <label for="price" class="form-label fw-bold">Precio por Persona <span class="text-danger">*</span></label>
            <div class="input-group">
                <span class="input-group-text">€</span>
                <input type="number" name="price" id="price" class="form-control" step="0.01" min="0" required placeholder="0.00"/>
            </div>
          </div>
        </div>

        <!-- Driver / Company Selection -->
        {% if user_role == 'ADMIN' %}
        <h5 class="mb-3 text-secondary border-bottom pb-2">Conductor / Empresa</h5>
        <div class="mb-4">
          <label for="idCompany" class="form-label fw-bold">Conductor <span class="text-danger">*</span></label>
          <select name="idCompany" id="idCompany" class="form-select" required>
            <option value="">Seleccione conductor...</option>
            {% for company in companies %}
            <option value="{{ company.idUser }}">
              {{ company.name }} ({{ company.email }})
            </option>
            {% endfor %}
          </select>
        </div>
        {% elif user_role == 'COMPANY' %}
        <div class="mb-4">
          <label class="form-label fw-bold">Conductor</label>
          <input type="text" class="form-control bg-light" value="{{ current_user.username if current_user else '' }}" readonly />
        </div>
        {% endif %}

        <!-- Price Preview -->
        <div class="alert alert-info shadow-sm">
          <h5 class="alert-heading"><i class="fas fa-calculator me-2"></i>Resumen de Precios</h5>
          <hr>
          <div class="d-flex justify-content-between mb-2">
            <span>Precio por persona:</span>
            <span id="pricePerPerson" class="fw-bold">€0.00</span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Número de personas:</span>
            <span id="numOccupants" class="fw-bold">0</span>
          </div>
          <div class="d-flex justify-content-between align-items-center mt-3 pt-2 border-top">
            <span class="fs-5">Precio Total:</span>
            <span id="totalPrice" class="fs-4 fw-bold text-success">€0.00</span>
          </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-4">
          <a href="{{ url_for('trip.list_trips') }}" class="btn btn-secondary">Cancelar</a>
          <button type="submit" class="btn btn-primary px-4"><i class="fas fa-check me-2"></i>Crear Viaje</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %} 

{% block extra_js %}
<script>
  // Convert datetime-local to required format on submit
  document.getElementById("tripForm").addEventListener("submit", function (e) {
    const startDate = document.getElementById("startDate").value;
    const endDate = document.getElementById("endDate").value;

    if (startDate) {
      // Input is yyyy-mm-ddThh:mm, backend expects yyyy/mm/dd hh:mm:ss
      const formattedStart = startDate.replace("T", " ") + ":00";
      document.getElementById("startDate").type = "text"; // Change type to allow custom format
      document.getElementById("startDate").value = formattedStart.replace(/-/g, "/");
    }

    if (endDate) {
      const formattedEnd = endDate.replace("T", " ") + ":00";
      document.getElementById("endDate").type = "text";
      document.getElementById("endDate").value = formattedEnd.replace(/-/g, "/");
    }
  });

  // Real-time price calculation
  function updatePricePreview() {
    const price = parseFloat(document.getElementById("price").value) || 0;
    const occupants = parseInt(document.getElementById("occupants").value) || 0;
    const total = price * occupants;

    document.getElementById("pricePerPerson").textContent = "€" + price.toFixed(2);
    document.getElementById("numOccupants").textContent = occupants;
    document.getElementById("totalPrice").textContent = "€" + total.toFixed(2);
  }

  document.getElementById("price").addEventListener("input", updatePricePreview);
  document.getElementById("occupants").addEventListener("input", updatePricePreview);
</script>
{% endblock %}
